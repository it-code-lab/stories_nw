<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Coloring Book Builder</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 20px;
      background: #f5f5f5;
      color: #222;
    }

    h1 {
      margin-bottom: 10px;
    }

    .panel {
      background: #ffffff;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    label {
      display: inline-block;
      margin: 6px 0 2px;
      font-size: 14px;
      font-weight: 500;
    }

    input[type="text"],
    input[type="number"],
    select {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 100%;
      max-width: 260px;
      font-size: 14px;
    }

    input[type="checkbox"] {
      transform: scale(1.1);
      margin-right: 4px;
    }

    .pages-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 420px;
      overflow-y: auto;
      margin-top: 8px;
    }

    .page-row {
      display: grid;
      grid-template-columns: 270px 1fr auto;
      gap: 8px;
      align-items: center;
      background: #fafafa;
      border-radius: 8px;
      padding: 6px 8px;
      border: 1px solid #e3e3e3;
    }

    .page-row img {
      width: 250px;
      height: 150px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: #fff;
    }

    .page-meta {
      font-size: 11px;
      line-height: 1.35;
    }

    .page-meta .name {
      font-weight: 600;
      font-size: 12px;
      margin-bottom: 2px;
    }

    .tag {
      display: inline-block;
      padding: 2px 6px;
      font-size: 9px;
      border-radius: 999px;
      background: #eef;
      margin-right: 4px;
    }

    .warning {
      color: #b06500;
      font-size: 9px;
    }

    .page-controls {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
      font-size: 10px;
    }

    .page-controls button {
      padding: 2px 6px;
      font-size: 9px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
    }

    .page-controls button:hover {
      background: #f0f0f0;
    }

    .btn-primary {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      background: #2563eb;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .hint {
      font-size: 11px;
      color: #666;
    }

    .inline {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-right: 12px;
      font-size: 11px;
    }

    .preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      max-height: 420px;
      overflow-y: auto;
      padding-top: 4px;
    }

    .preview-page {
      position: relative;
      background: #ffffff;
      border: 1px solid #e3e3e3;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      flex: 0 0 auto;
    }

    .preview-label {
      position: absolute;
      top: 4px;
      left: 6px;
      padding: 2px 6px;
      font-size: 9px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.1);
      color: #2563eb;
    }

    .preview-label.back {
      background: rgba(248, 113, 113, 0.1);
      color: #b91c1c;
    }

    .preview-footnote {
      position: absolute;
      left: 8px;
      right: 8px;
      bottom: 4px;
      font-size: 8px;
      color: #444;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .preview-pagenum {
      position: absolute;
      right: 8px;
      bottom: 4px;
      font-size: 8px;
      color: #111;
    }

    textarea {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 100%;
      max-width: 480px;
      font-size: 14px;
      resize: vertical;
      font-family: inherit;
    }
  </style>
</head>

<body>

  <h1>Coloring Book Builder</h1>
  <div class="panel">
    <div>
      <label>1. Load coloring pages</label><br>
      <input type="file" id="fileInput" multiple webkitdirectory>
      <div class="hint">
        Select your folder or multiple files. Only image files are used.
        Theyâ€™ll be sorted by file name by default.
      </div>

      <div style="margin-top:12px;">
        <label>Optional: Load fun activity pages (mazes, dot-to-dot, etc.)</label><br>
        <input type="file" id="activitiesInput" multiple webkitdirectory>
        <div class="hint" id="activitiesHint">
          Activity pages will be appended near the end in the Generate Book view.
        </div>
      </div>

      <div style="margin-top:10px;">
        <label>Or load from server folder (under /downloads)</label>
        <div class="inline">
          <input type="text" id="folderInput" placeholder="e.g. farm_animals">
          <button type="button" class="btn-primary" id="runUpscaleBtn">
            Upscale & Load
          </button>
        </div>
        <div class="hint">
          This will:
          1) Run upscaling on /downloads/&lt;folder&gt;/,
          2) Write pages into /downloads/&lt;folder&gt;/processed_images/,
          3) Load those processed pages into the builder.
        </div>
      </div>

    </div>
  </div>

  <div class="panel">
    <label>2. Page & branding settings</label>
    <div class="inline">
      <span>Page size:</span>
      <select id="pageSize">
        <option value="LETTER">8.5 x 11 in (recommended)</option>
        <option value="EIGHTX10">8 x 10 in</option>
      </select>
    </div>
    <div class="inline">
      <span>Margin (inches):</span>
      <input type="number" id="margin" value="0.5" step="0.1" min="0.25" max="1.0">
    </div>
    <div style="margin-top:6px;">
      <input type="checkbox" id="footerNoteCheckbx">
      <label>Footer text (copyright / brand)</label>
      <input type="text" id="footnote" value="Â© Creative Cubs | Personal use only | All rights reserved.">
    </div>
    <div style="margin-top:4px;">
      <label class="inline">
        <input type="checkbox" id="showPageNumbers" checked>
        Show page numbers (skip cover/back)
      </label>
      <label class="inline">
        Start from:
        <input type="number" id="pageNumberStart" value="1" min="1" style="width:60px;">
      </label>
    </div>
    <div style="margin-top:10px;">
      <input type="checkbox" id="showBookCoverDetails">
      <label>Book details (for Generate Book view)</label>
      <div>
        <input type="text" id="bookTitle" placeholder="Book title" value="Cute Farm Animals Coloring Book">
      </div>
      <div style="margin-top:4px;">
        <input type="text" id="bookSubtitle" placeholder="Subtitle" value="Fun & Easy Coloring Pages for Kids">
      </div>
      <div style="margin-top:4px;">
        <input type="text" id="bookAuthor" placeholder="Author / Brand" value="Creative Cubs">
      </div>
      <div style="margin-top:4px;">
        <input type="text" id="bookAgeRange" placeholder="Age range" value="Ages 3â€“8">
      </div>
    </div>

    <div style="margin-top:10px;">
      <label>Welcome / instructions text</label> <br>
      <textarea id="welcomeText" rows="3">
Welcome to the farm! This book is filled with cute animals, big barns, and sunny fields. 
Use crayons, markers, or colored pencils and place a scrap sheet behind pages when using markers.
Have fun and color outside the lines if you like!
      </textarea>
    </div>


    <div style="margin-top:10px;">
      <label>Thank-you / bonus text</label> <br>
      <textarea id="thankYouText" rows="4">
Thanks for coloring with Creative Cubs!
Color more free pages online at:
ðŸŒˆ https://coloring.readernook.com

Love this book? Discover more adorable books here:
ðŸ›’ https://goodsandgift.com/product-category/creative-crafting/

Use coupon code CREATIVE10 for a 10% discount on your next Creative Cubs coloring book!

      </textarea>
    </div>



    <div style="margin-top:10px;">
      <label>QR code image URL (optional)</label>
      <input type="text" id="qrUrl" value="images/goodsandgift-QR.png">
    </div>

    <div style="margin-top:10px;">
      <input type="checkbox" id="includeBackBlurb">
      <label>Back cover blurb</label> <br>
      <textarea id="backBlurb" rows="3">
Packed with adorable farm scenes, cute animals, and simple designs perfect for little hands. 
Great for ages 3â€“8, rainy days, car rides, and screen-free creative time.
      </textarea>
    </div>

    <div class="inline">
      <label class="inline">
        <input type="checkbox" id="landscapeToggle">
        Rotate images 90Â° (for landscape artwork)
      </label>
    </div>

    <div class="hint">
      Tip: Use clean black outlines, no backgrounds, for best professional print.
    </div>
  </div>

  <div class="panel">
    <label>3. Pages (reorder, mark Cover/Back, review quality)</label>
    <div id="pagesList" class="pages-list"></div>
    <div class="hint">
      Use Cover/Back buttons and â¬†â¬‡ to reorder.
      Warnings help you spot low-res or non-B&W images.
    </div>
  </div>

  <div class="panel">
    <label>4. Preview pages with layout</label>
    <div id="pagePreview" class="preview-container"></div>
    <div class="hint">
      This is an on-screen preview of how pages will be laid out: size, margins,
      cover/back, footer, and page numbers. Final PDF uses the same logic.
    </div>
  </div>

  <div class="panel">
    <label>4. Export</label><br>

    <button class="btn-primary" id="generateBookBtn" type="button">
      Generate Book (Print View)
    </button>

    <button class="btn-primary" id="generatePdfBtn" type="button" style="margin-left:8px;">
      Generate PDF
    </button>

    <div class="hint">
      Generated PDF will use your chosen page size, margins, centered images,
      footer text, and page numbers.
    </div>
    <hr style="margin:10px 0; border:none; border-top:1px solid #eee;">

    <label>5. Flip-through video preview</label><br>
    <div class="hint">
      Generates a short flip-through video using the processed images for the current folder.
      Perfect for Etsy / your website / social media listing previews.
    </div>
    <button class="btn-primary" id="generateFlipBtn" type="button">
      Generate Flip-Through Video
    </button>
    <div id="flipResult" class="hint" style="margin-top:8px;"></div>

  </div>

  <!-- jsPDF (browser PDF generation) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const { jsPDF } = window.jspdf;

    const fileInput = document.getElementById('fileInput');
    const pagesList = document.getElementById('pagesList');
    const generatePdfBtn = document.getElementById('generatePdfBtn');

    const pages = []; // {id, file, url, img, warnings, isCover, isBack, enabled}

    const folderInput = document.getElementById('folderInput');
    const runUpscaleBtn = document.getElementById('runUpscaleBtn');
    const pagePreview = document.getElementById('pagePreview');

    const generateFlipBtn = document.getElementById('generateFlipBtn');
    const flipResult = document.getElementById('flipResult');
    const generateBookBtn = document.getElementById('generateBookBtn');

    // Optional fun-activity pages (separate from normal pages)
    const activityPages = [];  // { file, url, img }
    const activitiesInput = document.getElementById('activitiesInput');
    const activitiesHint = document.getElementById('activitiesHint');
    const showBookCoverDetails = document.getElementById('showBookCoverDetails')?.checked;
    const includeBackBlurb = document.getElementById('includeBackBlurb')?.checked;
    const footerNoteCheckbx = document.getElementById('footerNoteCheckbx')?.checked;

    function renderPreview() {
      if (!pagePreview) return;
      pagePreview.innerHTML = '';

      if (!pages.length) return;

      const size = document.getElementById('pageSize').value;
      const marginInches = parseFloat(document.getElementById('margin').value) || 0.5;
      const showPageNumbers = document.getElementById('showPageNumbers').checked;
      const pageNumberStart = parseInt(document.getElementById('pageNumberStart').value || '1', 10);
      let footnote = (document.getElementById('footnote').value || '').trim();
      const landscape = document.getElementById('landscapeToggle')?.checked;


      if (!footerNoteCheckbx) {
        footnote = "";
      }

      // Base page size in inches
      let baseW, baseH;
      if (size === 'LETTER') {
        baseW = 8.5;
        baseH = 11;
      } else {
        baseW = 8;
        baseH = 10;
      }

      // Apply orientation toggle: swap for landscape
      let pageW = baseW;
      let pageH = baseH;
      if (landscape) {
        pageW = baseH;
        pageH = baseW;
      }

      // Scale pages for screen preview
      const maxPreviewHeight = 260; // px
      //const maxPreviewHeight = landscape ? 200 : 260;
      const scale = maxPreviewHeight / pageH;
      const pageWidthPx = pageW * scale;
      const pageHeightPx = pageH * scale;
      const marginPx = marginInches * scale;
      const footerHeightPx = (footnote || showPageNumbers) ? 14 : 0;

      const ordered = getOrderedPages().filter(p => p.enabled);
      if (!ordered.length) return;

      let pageNumber = pageNumberStart - 1;

      ordered.forEach(page => {
        const wrapper = document.createElement('div');
        wrapper.className = 'preview-page';
        wrapper.style.width = pageWidthPx + 'px';
        wrapper.style.height = pageHeightPx + 'px';

        if (page.isCover) {
          const lbl = document.createElement('div');
          lbl.className = 'preview-label';
          lbl.textContent = 'Cover';
          wrapper.appendChild(lbl);
        } else if (page.isBack) {
          const lbl = document.createElement('div');
          lbl.className = 'preview-label back';
          lbl.textContent = 'Back';
          wrapper.appendChild(lbl);
        }

        const maxW = pageWidthPx - 2 * marginPx;
        const maxH = pageHeightPx - 2 * marginPx - footerHeightPx;

        const imgRatio = page.img.width / page.img.height;
        const boxRatio = maxW / maxH;

        let drawW, drawH;
        if (imgRatio > boxRatio) {
          drawW = maxW;
          drawH = maxW / imgRatio;
        } else {
          drawH = maxH;
          drawW = maxH * imgRatio;
        }

        const x = (pageWidthPx - drawW) / 2;
        const y = marginPx + (maxH - drawH) / 2;

        const img = document.createElement('img');
        img.src = page.url;
        img.style.position = 'absolute';
        img.style.left = x + 'px';
        img.style.top = y + 'px';
        img.style.width = drawW + 'px';
        img.style.height = drawH + 'px';
        img.style.objectFit = 'contain';
        wrapper.appendChild(img);

        const isNumbered = !page.isCover && !page.isBack;

        if (footnote && isNumbered) {
          const foot = document.createElement('div');
          foot.className = 'preview-footnote';
          foot.textContent = footnote;
          wrapper.appendChild(foot);
        }

        if (showPageNumbers && isNumbered) {
          pageNumber++;
          const num = document.createElement('div');
          num.className = 'preview-pagenum';
          num.textContent = String(pageNumber);
          wrapper.appendChild(num);
        }

        pagePreview.appendChild(wrapper);
      });
    }

    function loadImage(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = (err) => reject(err || new Error('Image load error'));
        img.src = url;
      });
    }
    function inferFolderNameFromFiles(fileList) {
      const files = Array.from(fileList || []);
      if (!files.length) return "";

      // Prefer using webkitRelativePath if available (folder selection)
      const paths = files
        .map(f => f.webkitRelativePath || f.name)
        .filter(Boolean);

      // If none have a path, we can't infer a folder
      if (!paths.length) return "";

      // Take the first segment before '/'
      const first = paths[0].split("/")[0];

      // Basic sanity check: ensure most files share this root
      const sameRootCount = paths.filter(p => p.startsWith(first + "/")).length;
      if (sameRootCount < paths.length * 0.7) {
        return "";
      }

      return first;
    }

    if (generateFlipBtn) {
      generateFlipBtn.addEventListener('click', async () => {
        const folder = (folderInput.value || '').trim().replace(/^\/+|\/+$/g, '');
        if (!folder) {
          alert('Please enter or load a folder name (under /downloads) first.');
          return;
        }

        flipResult.textContent = 'Creating flip-through video...';

        try {
          const res = await fetch('/api/generate_flipthrough', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              folder,
              seconds_per_image: 1.5,  // adjust if you want slower/faster
              width: 1920,
              height: 1080,
              watermark_text: 'Â© Creative Cubs - Preview'
            })
          });

          const data = await res.json();
          if (!data.ok) {
            flipResult.textContent = 'Error: ' + (data.error || 'Could not generate video.');
            return;
          }

          const url = data.url;

          // Show playable video + link
          flipResult.innerHTML = `
        <div style="margin-top:6px;">
          <video src="${url}" controls style="max-width:320px; width:100%; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.15);"></video>
          <div class="hint" style="margin-top:4px;">
            Flip-through video generated:
            <a href="${url}" target="_blank" download>Download MP4</a>
          </div>
        </div>
      `;
        } catch (err) {
          console.error(err);
          flipResult.textContent = 'Error: Request failed. See console/server logs.';
        }
      });
    }

    if (runUpscaleBtn) {
      runUpscaleBtn.addEventListener('click', async () => {
        const folder = folderInput.value.trim();
        const size = document.getElementById('pageSize').value;
        console.log("Calling upscale")
        const res = await fetch('/api/upscale_coloring', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ folder, page_size: size, threshold: 200 })
        });

        const data = await res.json();
        if (!data.ok) {
          alert('Upscale error: ' + (data.error || 'Unknown error'));
          return;
        }

        pages.length = 0;
        pagesList.innerHTML = '';

        for (const item of data.processed) {
          const url = item.url;

          let img;
          try {
            img = await loadImage(url);
          } catch (err) {
            console.error('Failed to load processed image:', item.file, url, err);
            continue;
          }

          const warnings = analyzeImage(img, item.file || "");
          const page = {
            id: crypto.randomUUID(),
            file: { name: item.file },
            url,
            img,
            warnings,
            isCover: false,
            isBack: false,
            enabled: true
          };
          pages.push(page);
          addPageRow(page);
        }
        renderPreview();

        console.log("Upscaling completed")
      });

    }

    fileInput.addEventListener('change', async (e) => {
      pages.length = 0;
      pagesList.innerHTML = '';

      const files = Array.from(e.target.files)
        .filter(f => f.type.startsWith('image/'))
        .sort((a, b) => a.name.localeCompare(b.name));

      // ðŸ”¹ NEW: auto-fill folderInput if we can infer it
      if (typeof folderInput !== 'undefined' && folderInput) {
        const inferred = inferFolderNameFromFiles(e.target.files);
        if (inferred) {
          folderInput.value = inferred;
        }
      }

      for (const file of files) {
        const url = URL.createObjectURL(file);

        let img;
        try {
          img = await loadImage(url);
        } catch (err) {
          console.error('Failed to load local image:', file.name, err);
          continue;
        }

        const warnings = analyzeImage(img, file.name);
        const page = {
          id: crypto.randomUUID(),
          file,
          url,
          img,
          warnings,
          isCover: false,
          isBack: false,
          enabled: true
        };
        pages.push(page);
        addPageRow(page);
      }
      renderPreview();


    });

    if (activitiesInput) {
      activitiesInput.addEventListener('change', async (e) => {
        activityPages.length = 0;

        const files = Array.from(e.target.files)
          .filter(f => f.type.startsWith('image/'))
          .sort((a, b) => a.name.localeCompare(b.name));

        for (const file of files) {
          const url = URL.createObjectURL(file);
          let img;
          try {
            img = await loadImage(url);
          } catch (err) {
            console.error('Failed to load activity image:', file.name, err);
            continue;
          }
          activityPages.push({ file, url, img });
        }

        if (activitiesHint) {
          if (activityPages.length) {
            activitiesHint.textContent =
              `${activityPages.length} activity pages loaded. They will appear near the end in Generate Book view.`;
          } else {
            activitiesHint.textContent =
              'No activity pages loaded yet.';
          }
        }
      });
    }

    function analyzeImage(img, fileName = "") {
      const warnings = [];

      // If it's one of our processed files, be more lenient
      const isUpscaled = fileName.includes("_upscaled");

      const w = img.width;
      const h = img.height;
      const longSide = Math.max(w, h);
      const shortSide = Math.min(w, h);

      // For your flow (8.5x11 / 8x10 @ ~300dpi, line art):
      // - longSide >= 2000px is plenty
      // - shortSide >= 1100px is fine for landscape band-style art
      if (!isUpscaled) {
        if (longSide < 1600 || shortSide < 900) {
          warnings.push("Low resolution: may look soft when printed large.");
        }
      } else {
        if (longSide < 2000 || shortSide < 1100) {
          warnings.push("Potentially low resolution even after upscaling. Check this page.");
        }
      }

      // Simple B/W cleanliness check (unchanged)
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const s = 80;
      canvas.width = s;
      canvas.height = s;
      ctx.drawImage(img, 0, 0, s, s);
      const data = ctx.getImageData(0, 0, s, s).data;

      let colored = 0;
      const total = s * s;
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i], g = data[i + 1], b = data[i + 2];
        const max = Math.max(r, g, b), min = Math.min(r, g, b);
        if (!(r > 240 && g > 240 && b > 240) &&  // not white
          !(r < 35 && g < 35 && b < 35)) {     // not black
          if (max - min > 15) colored++;
        }
      }
      if (colored / total > 0.02) {
        warnings.push("Not pure B&W: consider cleaning colors/gray areas.");
      }

      return warnings;
    }

    function analyzeImage_old(img) {
      const warnings = [];

      // 1. Resolution check (simple heuristic for ~300 DPI)
      if (img.width < 2000 || img.height < 2000) {
        warnings.push('Low resolution: may look soft when printed large.');
      }

      // 2. Simple "is mostly black & white" check by sampling
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const s = 80;
      canvas.width = s;
      canvas.height = s;
      ctx.drawImage(img, 0, 0, s, s);
      const data = ctx.getImageData(0, 0, s, s).data;

      let colored = 0;
      let total = s * s;
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i], g = data[i + 1], b = data[i + 2];
        const max = Math.max(r, g, b), min = Math.min(r, g, b);
        // check how "chromatic" it is
        if (!(r > 240 && g > 240 && b > 240) && // not white
          !(r < 35 && g < 35 && b < 35)) {    // not black
          if (max - min > 15) colored++;
        }
      }
      if (colored / total > 0.02) {
        warnings.push('Not pure B&W: consider cleaning colors/gray areas.');
      }

      return warnings;
    }

    function addPageRow(page) {
      const row = document.createElement('div');
      row.className = 'page-row';
      row.dataset.id = page.id;

      const thumb = document.createElement('img');
      thumb.src = page.url;

      const meta = document.createElement('div');
      meta.className = 'page-meta';

      const name = document.createElement('div');
      name.className = 'name';
      name.textContent = page.file.name;
      meta.appendChild(name);

      const tags = document.createElement('div');
      tags.innerHTML = '<span class="tag">Page</span>';
      meta.appendChild(tags);

      if (page.warnings.length) {
        const w = document.createElement('div');
        w.className = 'warning';
        w.textContent = page.warnings.join(' | ');
        meta.appendChild(w);
      }

      const controls = document.createElement('div');
      controls.className = 'page-controls';

      const includeLabel = document.createElement('label');
      includeLabel.innerHTML = `<input type="checkbox" checked> Include`;
      const includeCheckbox = includeLabel.querySelector('input');
      includeCheckbox.addEventListener('change', () => {
        page.enabled = includeCheckbox.checked;
        row.style.opacity = page.enabled ? '1' : '0.4';
        renderPreview();
      });
      controls.appendChild(includeLabel);

      const coverBtn = document.createElement('button');
      coverBtn.textContent = 'Set as Cover';
      coverBtn.addEventListener('click', () => {
        pages.forEach(p => p.isCover = false);
        page.isCover = true;
        refreshTags();
        renderPreview();
      });
      controls.appendChild(coverBtn);

      const backBtn = document.createElement('button');
      backBtn.textContent = 'Set as Back';
      backBtn.addEventListener('click', () => {
        pages.forEach(p => p.isBack = false);
        page.isBack = true;
        refreshTags();
        renderPreview();
      });
      controls.appendChild(backBtn);

      const upBtn = document.createElement('button');
      upBtn.textContent = 'â¬†';
      upBtn.title = 'Move up';
      upBtn.addEventListener('click', () => movePage(page.id, -1));
      controls.appendChild(upBtn);

      const downBtn = document.createElement('button');
      downBtn.textContent = 'â¬‡';
      downBtn.title = 'Move down';
      downBtn.addEventListener('click', () => movePage(page.id, 1));
      controls.appendChild(downBtn);

      row.appendChild(thumb);
      row.appendChild(meta);
      row.appendChild(controls);

      pagesList.appendChild(row);
      refreshTags();
    }

    function movePage(id, delta) {
      const index = pages.findIndex(p => p.id === id);
      if (index < 0) return;
      const newIndex = index + delta;
      if (newIndex < 0 || newIndex >= pages.length) return;
      const [p] = pages.splice(index, 1);
      pages.splice(newIndex, 0, p);
      renderAllRows();
      renderPreview();
    }

    function refreshTags() {
      // Update tags (Cover / Back) visuals
      document.querySelectorAll('.page-row').forEach(row => {
        const id = row.dataset.id;
        const page = pages.find(p => p.id === id);
        const meta = row.querySelector('.page-meta');
        const tagsDiv = meta.querySelector('div');
        tagsDiv.innerHTML = '';

        if (page.isCover) {
          tagsDiv.innerHTML += `<span class="tag" style="background:#dcfce7;">Cover</span>`;
        } else if (page.isBack) {
          tagsDiv.innerHTML += `<span class="tag" style="background:#fee2e2;">Back</span>`;
        } else {
          tagsDiv.innerHTML += `<span class="tag">Page</span>`;
        }
      });
    }

    function renderAllRows() {
      pagesList.innerHTML = '';
      pages.forEach(p => addPageRow(p));
    }

    function getOrderedPages() {
      const enabled = pages.filter(p => p.enabled);
      const cover = enabled.find(p => p.isCover);
      const back = enabled.find(p => p.isBack);

      const middle = enabled.filter(p => !p.isCover && !p.isBack);

      const ordered = [];
      if (cover) ordered.push(cover);
      ordered.push(...middle);
      if (back) ordered.push(back);
      return ordered;
    }

    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"']/g, (ch) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[ch] || ch));
    }


    generatePdfBtn.addEventListener('click', () => {
      if (!pages.length) {
        alert('Please load images first.');
        return;
      }

      const size = document.getElementById('pageSize').value;
      const marginInches = parseFloat(document.getElementById('margin').value) || 0.5;
      const showPageNumbers = document.getElementById('showPageNumbers').checked;
      const pageNumberStart = parseInt(document.getElementById('pageNumberStart').value || '1', 10);
      let footnote = (document.getElementById('footnote').value || '').trim();
      const landscape = document.getElementById('landscapeToggle')?.checked;

      const ptPerInch = 72;

      // Base size in inches
      let baseWIn, baseHIn;
      if (size === 'LETTER') {
        baseWIn = 8.5;
        baseHIn = 11;
      } else {
        baseWIn = 8;
        baseHIn = 10;
      }

      // Adjust for orientation
      let pageWidthIn = baseWIn;
      let pageHeightIn = baseHIn;
      // if (landscape) {
      //   pageWidthIn = baseHIn;
      //   pageHeightIn = baseWIn;
      // }

      const pageWidthPt = pageWidthIn * ptPerInch;
      const pageHeightPt = pageHeightIn * ptPerInch;

      const marginPt = marginInches * ptPerInch;
      const footerHeight = (footnote || showPageNumbers) ? 16 : 0;

      const doc = new jsPDF({
        unit: 'pt',
        format: [pageWidthPt, pageHeightPt],
        orientation: 'portrait'
      });

      let pageNumber = pageNumberStart - 1;

      const ordered = getOrderedPages().filter(p => p.enabled && !p.isCover && !p.isBack);

      const rotateImages = document.getElementById('landscapeToggle')?.checked;

      ordered.forEach((page, index) => {
        if (index > 0) {
          doc.addPage();
        }

        // 1) Choose image source: original or rotated-on-canvas
        let srcImg = page.img;

        if (rotateImages) {
          const c = document.createElement('canvas');
          // swap width/height for 90deg rotation
          c.width = srcImg.height;
          c.height = srcImg.width;

          const ctx = c.getContext('2d');
          ctx.translate(c.width / 2, c.height / 2);
          ctx.rotate(Math.PI / 2); // 90 degrees clockwise
          ctx.drawImage(srcImg, -srcImg.width / 2, -srcImg.height / 2);

          srcImg = c; // use the rotated canvas as the image source
        }

        // 2) Fit srcImg into page box (portrait page)
        const maxWidth = pageWidthPt - 2 * marginPt;
        const maxHeight = pageHeightPt - 2 * marginPt - footerHeight;

        const imgRatio = srcImg.width / srcImg.height;
        const boxRatio = maxWidth / maxHeight;

        let drawWidth, drawHeight;
        if (imgRatio > boxRatio) {
          drawWidth = maxWidth;
          drawHeight = maxWidth / imgRatio;
        } else {
          drawHeight = maxHeight;
          drawWidth = maxHeight * imgRatio;
        }

        const x = (pageWidthPt - drawWidth) / 2;
        const y = marginPt + (maxHeight - drawHeight) / 2;

        // 3) Add image to PDF with NO extra rotation
        doc.addImage(
          srcImg,
          'PNG',
          x,
          y,
          drawWidth,
          drawHeight,
          undefined,
          'FAST'
        );

        // 4) Footer + page numbers (unchanged)
        const isCover = page.isCover;
        const isBack = page.isBack;
        const isNumbered = !isCover && !isBack;

        if (footnote && isNumbered) {
          doc.setFontSize(9);
          doc.text(footnote, marginPt, pageHeightPt - marginPt - 4, { baseline: 'bottom' });
        }

        if (showPageNumbers && isNumbered) {
          pageNumber++;
          doc.setFontSize(9);
          doc.text(
            String(pageNumber),
            pageWidthPt - marginPt,
            pageHeightPt - marginPt - 4,
            { align: 'right', baseline: 'bottom' }
          );
        }
      });


      doc.save('coloring-book.pdf');
    });

    if (generateBookBtn) {
      generateBookBtn.addEventListener('click', () => {
        if (!pages.length) {
          alert('Please load coloring pages first.');
          return;
        }
        openPrintBookWindow();
      });
    }

    function openPrintBookWindow() {
      const size = document.getElementById('pageSize').value;
      const marginInches = parseFloat(document.getElementById('margin').value) || 0.5;
      const showPageNumbers = document.getElementById('showPageNumbers').checked;
      const pageNumberStart = parseInt(document.getElementById('pageNumberStart').value || '1', 10);
      let footnote = (document.getElementById('footnote').value || '').trim();
      const rotateImages = document.getElementById('landscapeToggle')?.checked;

      const bookTitle = (document.getElementById('bookTitle')?.value || '').trim();
      const bookSubtitle = (document.getElementById('bookSubtitle')?.value || '').trim();
      const bookAuthor = (document.getElementById('bookAuthor')?.value || '').trim();
      const bookAgeRange = (document.getElementById('bookAgeRange')?.value || '').trim();
      const welcomeText = (document.getElementById('welcomeText')?.value || '').trim();
      const thankYouText = (document.getElementById('thankYouText')?.value || '').trim();
      const qrUrl = (document.getElementById('qrUrl')?.value || '').trim();
      const backBlurb = (document.getElementById('backBlurb')?.value || '').trim();

      // getOrderedPages returns pages in [cover, middle..., back] order,
      // but for interior pages we want to be extra sure we NEVER include cover/back again.
      const ordered = getOrderedPages();
      const coverPage = ordered.find(p => p.isCover) || null;
      const backPage = ordered.find(p => p.isBack) || null;

      // Interior pages = all enabled pages that are NOT cover or back,
      // in whatever order you arranged them in the main list.
      const interiorPages = pages.filter(p => p.enabled && !p.isCover && !p.isBack);

      // Decide how many activity pages to include:
      // ~10% of interior pages, min 4, max 16, but never more than we actually have.
      const totalColoringPages = interiorPages.length;
      let maxActivityCount = Math.round(totalColoringPages * 0.10);

      if (maxActivityCount < 4) {
        maxActivityCount = 4;
      }
      if (maxActivityCount > 16) {
        maxActivityCount = 16;
      }

      // If there are fewer activity pages than the cap, just use them all.
      const selectedActivityPages = activityPages.slice(0, maxActivityCount);


      if (!ordered.length) {
        alert('No pages selected.');
        return;
      }

      const pageWidthIn = (size === 'LETTER') ? 8.5 : 8;
      const pageHeightIn = (size === 'LETTER') ? 11 : 10;

      const win = window.open('', '_blank');
      if (!win) {
        alert('Popup blocked. Please allow popups for this site.');
        return;
      }

      const doc = win.document;
      const css = `
        @page { size: ${pageWidthIn}in ${pageHeightIn}in; margin: 0; }
        body {
          margin: 0;
          padding: 0;
          background: #e5e7eb;
          font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .book-page {
          width: ${pageWidthIn}in;
          height: ${pageHeightIn}in;
          box-sizing: border-box;
          margin: 0 auto 0.2in auto;
          background: #ffffff;
          padding: ${marginInches}in;
          position: relative;
          page-break-after: always;
        }
        .page-inner {
          width: 100%;
          height: 100%;
          box-sizing: border-box;
        }
        .center { text-align: center; }
        h1 { font-size: 26pt; margin: 0 0 0.2in 0; }
        h2 { font-size: 18pt; margin: 0 0 0.15in 0; }
        h3 { font-size: 14pt; margin: 0 0 0.1in 0; color: #555; }
        p { font-size: 11pt; line-height: 1.4; margin: 0 0 0.12in 0; }
        ul { font-size: 11pt; line-height: 1.4; margin: 0.05in 0 0.12in 0.15in; }
        .belongs-box {
          border: 2px dashed #9ca3af;
          border-radius: 0.2in;
          padding: 0.3in;
          margin-top: 0.4in;
          font-size: 18pt;
        }
        .belongs-label {
          font-size: 12pt;
          margin-bottom: 0.2in;
        }
        .image-wrapper {
          width: 100%;
          height: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .image-wrapper img {
          max-width: 100%;
          max-height: 100%;
        }
        .thumb-grid {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 0.12in;
          margin-top: 0.15in;
        }
        .thumb-grid img {
          width: 100%;
          border: 1px solid #e5e7eb;
        }
        .page-footer {
          position: absolute;
          left: ${marginInches}in;
          right: ${marginInches}in;
          bottom: ${marginInches}in;
          font-size: 9pt;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        .page-footer-num {
          margin-left: auto;
        }
        .qr {
          margin-top: 0.3in;
        }
      `;

      doc.open();
      doc.write(`
        <!DOCTYPE html>
        <html>
          <head>
            <meta charset="UTF-8">
            <title>${escapeHtml(bookTitle || 'Coloring Book')}</title>
            <style>${css}</style>
          </head>
          <body></body>
        </html>
      `);
      doc.close();

      const body = doc.body;
      let currentNumber = pageNumberStart - 1;

      if (!footerNoteCheckbx) {
        footnote = "";
      }

      function addFooter(pageEl, skipNumber) {
        if (!footnote && !showPageNumbers) return;
        const footer = doc.createElement('div');
        footer.className = 'page-footer';
        if (footnote) {
          const left = doc.createElement('span');
          left.textContent = footnote;
          footer.appendChild(left);
        }
        if (showPageNumbers && !skipNumber) {
          currentNumber++;
          const num = doc.createElement('span');
          num.className = 'page-footer-num';
          num.textContent = String(currentNumber);
          footer.appendChild(num);
        }
        pageEl.appendChild(footer);
      }

      function addStaticPage(htmlContent, options = {}) {
        const page = doc.createElement('div');
        page.className = 'book-page';
        const inner = doc.createElement('div');
        inner.className = 'page-inner';
        inner.innerHTML = htmlContent;
        page.appendChild(inner);
        addFooter(page, options.skipNumber);
        body.appendChild(page);
      }

      function getPageImageSrc(page) {
        if (!rotateImages) return page.url;
        const c = document.createElement('canvas');
        const srcImg = page.img;
        c.width = srcImg.height;
        c.height = srcImg.width;
        const ctx = c.getContext('2d');
        ctx.translate(c.width / 2, c.height / 2);
        ctx.rotate(Math.PI / 2); // 90Â°
        ctx.drawImage(srcImg, -srcImg.width / 2, -srcImg.height / 2);
        return c.toDataURL('image/png');
      }

      function getPageImageSrcNoRotate(page) {
        // Always use the original orientation
        return page.url;
      }

      function addCoverPage(imgSrc) {
        const page = doc.createElement('div');
        page.className = 'book-page';

        // OVERRIDE margins for cover
        page.style.padding = '0';
        page.style.margin = '0 auto';

        const inner = doc.createElement('div');
        inner.className = 'page-inner';
        inner.style.padding = '0';

        const wrap = doc.createElement('div');
        wrap.className = 'image-wrapper';
        wrap.style.padding = '0';
        wrap.style.margin = '0';

        const img = doc.createElement('img');
        img.src = imgSrc;

        wrap.appendChild(img);
        inner.appendChild(wrap);
        page.appendChild(inner);

        // Cover = no page number
        addFooter(page, true);

        body.appendChild(page);
      }

      function addImagePage(imgSrc, options = {}) {
        const skipNumber = !!options.skipNumber;

        const page = doc.createElement('div');
        page.className = 'book-page';
        const inner = doc.createElement('div');
        inner.className = 'page-inner';

        const wrap = doc.createElement('div');
        wrap.className = 'image-wrapper';
        const img = doc.createElement('img');
        img.src = imgSrc;
        wrap.appendChild(img);

        inner.appendChild(wrap);
        page.appendChild(inner);
        addFooter(page, skipNumber);
        body.appendChild(page);
      }


      function buildThumbGrid(imgSrcs) {
        return `
          <div class="thumb-grid">
            ${imgSrcs.map(src => `<img src="${src}">`).join('')}
          </div>
        `;
      }

      // 0) Cover image (if any, no number)
      // COVER PAGE (always no rotation, no margins)
      if (coverPage) {
        const coverSrc = getPageImageSrcNoRotate(coverPage);
        addCoverPage(coverSrc);
      }


      // 1) Title page (no number)
      if (showBookCoverDetails) {
        addStaticPage(`
          <div class="center">
            <h1>${escapeHtml(bookTitle || 'Coloring Book')}</h1>
            ${bookSubtitle ? `<h2>${escapeHtml(bookSubtitle)}</h2>` : ''}
            ${bookAgeRange ? `<h3>${escapeHtml(bookAgeRange)}</h3>` : ''}
            ${bookAuthor ? `<p>by ${escapeHtml(bookAuthor)}</p>` : ''}
          </div>
        `, { skipNumber: true });
      }

      // 2) This Book Belongs To (no number)
      addStaticPage(`
        <div class="center">
          <h2>This Book Belongs To</h2>
          <div class="belongs-box">
            <div class="belongs-label">Write your name here</div>
            _______________________________
          </div>
        </div>
      `, { skipNumber: true });

      // 3) Welcome / Instructions (no number)
      if (welcomeText) {
        addStaticPage(`
          <h2 class="center">Welcome!</h2>
          <p>${escapeHtml(welcomeText).replace(/\n/g, '<br>')}</p>
        `, { skipNumber: true });
      }

      // 4) Interior coloring pages list (we'll use it for preview + full pages)

      // 4a) Preview page (comes BEFORE full-size pages, numbered)
      const previewImgs = interiorPages.slice(0, 12).map(p => getPageImageSrc(p));
      if (previewImgs.length) {
        addStaticPage(`
          <div class="center">
            <h2>Preview Pages</h2>
            <p>A quick look at some of the fun coloring pages inside.</p>
          </div>
          ${buildThumbGrid(previewImgs)}
        `, { skipNumber: true });
      }

      // 5) Main coloring pages (full-size, numbered)
      interiorPages.forEach(p => {
        const src = getPageImageSrc(p);
        addImagePage(src);
      });

      // 6) Activity pages (if any, numbered, with separator)
      if (selectedActivityPages.length) {
        // Separator page: not numbered
        addStaticPage(`
          <div class="center">
            <h2>Bonus Activity Pages</h2>
            <p>Have extra fun with these find-the-difference and puzzle pages!</p>
          </div>
        `, { skipNumber: true });

        // Now add the selected activity pages as normal numbered pages
        selectedActivityPages.forEach(p => {
          const src = rotateImages ? getPageImageSrc(p) : p.url;
          addImagePage(src);
        });
      }


      // 7) Thank You / Bonus page (numbered)
      if (thankYouText || qrUrl) {
        addStaticPage(`
          <div class="center">
            <h2>Thank You!</h2>
          </div>
          <p>${escapeHtml(thankYouText).replace(/\n/g, '<br>')}</p>
          ${qrUrl ? `<div class="qr center">
              <img src="${qrUrl}" alt="QR code" style="max-width:1in;">
            </div>` : ''}
        `, { skipNumber: true });
      }

      // 8) Back cover (no number)
      if (includeBackBlurb && backBlurb) {
        addStaticPage(`
          <div class="center">
            <h2>${escapeHtml(bookTitle || 'Coloring Book')}</h2>
          </div>
          <p>${escapeHtml(backBlurb).replace(/\n/g, '<br>')}</p>

        `, { skipNumber: true });
      }


      //DND - Working
      // 9) Back cover image (if any, no number)
      if (backPage) {
        const backSrc = getPageImageSrc(backPage);
        addImagePage(backSrc, { skipNumber: true });
      }
      // At this point the user can use the browser's Print â†’ Save as PDF.
    }

    ['pageSize', 'margin', 'footnote', 'showPageNumbers', 'pageNumberStart', 'landscapeToggle'].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      const evt = (el.tagName === 'SELECT' || el.type === 'checkbox') ? 'change' : 'input';
      el.addEventListener(evt, renderPreview);
    });


  </script>
</body>

</html>